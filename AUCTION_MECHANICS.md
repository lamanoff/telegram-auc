# Спецификация механики аукционов

## Обзор

Платформа реализует многораундовую систему аукционов, где в каждом раунде определяется группа победителей, получающих товар. Остальные участники продолжают участие в следующих раундах. Система включает механизмы защиты от "снайперских" ставок в последнюю секунду и обеспечивает финансовую корректность всех операций.

**Демо:** https://lamanoff-telegram-auc-a9a8.twc1.net/

---

## 1. Структура аукциона

### 1.1 Параметры аукциона

- **totalItems** — общее количество товаров на аукционе
- **roundsCount** — количество раундов
- **itemsPerRound** — количество товаров, разыгрываемых в каждом раунде
- **startingPrice** — начальная цена ставки
- **minIncrement** — минимальный шаг повышения ставки
- **reservePrice** (опционально) — резервная цена (минимальная цена для победы)
- **firstRoundDurationSec** — длительность первого раунда в секундах
- **roundDurationSec** — длительность последующих раундов в секундах
- **currency** — валюта аукциона (TON или USDT)

### 1.2 Статусы аукциона

- **scheduled** — запланирован, ожидает времени старта
- **active** — активен, принимает ставки
- **completed** — завершен, все товары проданы или все раунды пройдены
- **cancelled** — отменен администратором

### 1.3 Жизненный цикл аукциона

1. **Создание** — администратор создает аукцион со статусом `scheduled`
2. **Запуск** — по достижении `startTime` аукцион автоматически переходит в статус `active`, начинается раунд 1
3. **Раунды** — каждый раунд длится определенное время, по истечении определяются победители
4. **Завершение** — аукцион завершается когда:
   - Все раунды пройдены (`currentRound >= roundsCount`)
   - Все товары проданы (`itemsSold >= totalItems`)

---

## 2. Раунды и тайминги

### 2.1 Структура раундов

- **Раунд 1** начинается при старте аукциона и длится `firstRoundDurationSec` секунд
- **Раунды 2+** начинаются сразу после завершения предыдущего раунда и длятся `roundDurationSec` секунд
- Каждый раунд имеет поле `roundEndsAt` — точное время окончания раунда

### 2.2 Автоматическое управление раундами

Система использует планировщик (`auctionScheduler`), который каждую секунду:
1. Проверяет запланированные аукционы и запускает их при достижении `startTime`
2. Проверяет активные аукционы и завершает раунды, у которых `roundEndsAt <= now`

### 2.3 Переход между раундами

После завершения раунда:
- Если аукцион не завершен → начинается следующий раунд (`currentRound += 1`)
- Если аукцион завершен → статус меняется на `completed`, все оставшиеся ставки помечаются как `lost`

---

## 3. Ставки и ранжирование

### 3.1 Правила размещения ставок

- **Одна активная ставка** — каждый пользователь может иметь только одну активную ставку на аукцион
- **Только повышение** — новая ставка должна быть выше текущей ставки пользователя
- **Минимальный шаг** — разница между новой и текущей ставкой должна быть >= `minIncrement`
- **Минимальная ставка** — ставка должна быть >= текущей минимальной ставки для попадания в топ

### 3.2 Ранжирование ставок

Ставки ранжируются по двум критериям (в порядке приоритета):
1. **Сумма ставки** (`amountSort`) — по убыванию
2. **Время размещения** (`lastBidAt`) — при равенстве сумм, раньше размещенная ставка выше

Индекс в базе данных: `{ auctionId: 1, amountSort: -1, lastBidAt: 1 }`

### 3.3 Расчет минимальной ставки

Минимальная ставка рассчитывается динамически на основе:
- Текущего раунда
- Начальной цены (`startingPrice`)
- Минимального шага (`minIncrement`)
- Текущих топ-ставок

**Формула:**
```
dynamicMinPrice = startingPrice + (minIncrement * (currentRound - 1))
```

**Если все слоты заполнены:**
```
competitiveMinPrice = lowestTopBid + minIncrement
minRequiredBid = max(dynamicMinPrice, competitiveMinPrice)
```

**Если есть свободные слоты:**
```
minRequiredBid = dynamicMinPrice
```

**Пример:**
- `startingPrice = 1 TON`, `minIncrement = 0.1 TON`
- Раунд 1: минимальная ставка = 1 TON
- Раунд 2: минимальная ставка = 1.1 TON (1 + 0.1 * 1)
- Раунд 3: минимальная ставка = 1.2 TON (1 + 0.1 * 2)

### 3.4 Прогноз минимальной ставки для следующего раунда

Для следующего раунда минимальная ставка будет:
```
nextRoundMinPrice = startingPrice + (minIncrement * currentRound)
```

Это позволяет пользователям планировать ставки заранее.

---

## 4. Определение победителей в каждом раунде

### 4.1 Процесс определения победителей

При завершении раунда (`finalizeRound`):

1. **Вычисление лимита товаров:**
   ```
   remainingItems = max(totalItems - itemsSold, 0)
   limit = min(itemsPerRound, remainingItems)
   ```

2. **Выбор топ-ставок:**
   - Выбираются топ-N активных ставок (где N = `limit`)
   - Сортировка: `amountSort DESC, lastBidAt ASC`

3. **Применение резервной цены (если установлена):**
   - Если `reservePrice` установлена, отфильтровываются только ставки >= `reservePrice`
   - Если после фильтрации ставок меньше, чем `limit`, победителей будет меньше

4. **Определение победителей:**
   - Каждая ставка из отфильтрованного списка становится победителем
   - Ставка помечается как `won` с полем `wonRound = currentRound`
   - Создается запись `Item` для каждого победителя
   - Создается запись `RoundResult` с информацией о победителях раунда

### 4.2 Обработка оставшихся ставок

**Если аукцион продолжается:**
- Оставшиеся активные ставки остаются активными и участвуют в следующем раунде

**Если аукцион завершен:**
- Все оставшиеся активные ставки помечаются как `lost`
- Средства возвращаются пользователям (см. раздел 5.3)

### 4.3 Пограничные случаи

- **Нет активных ставок** — раунд завершается без победителей, начинается следующий раунд
- **Ставок меньше, чем товаров** — все ставки становятся победителями
- **Все товары проданы до завершения всех раундов** — аукцион завершается досрочно
- **Резервная цена не достигнута** — победителей может быть меньше, чем `itemsPerRound`

---

## 5. Обработка денег и ставок

### 5.1 Блокировка средств при размещении ставки

**При первой ставке:**
- Вся сумма ставки блокируется: `locked += amount`
- Создается транзакция типа `bid_lock`

**При повышении ставки:**
- Блокируется только разница: `locked += (newAmount - oldAmount)`
- Создается транзакция типа `bid_lock` на сумму разницы

**Важно:** Проверка баланса происходит **до** добавления в очередь обработки ставок, чтобы избежать очередей с недостаточным балансом.

### 5.2 Списание средств при выигрыше

При определении победителя раунда:
- Средства списываются: `total -= amount, locked -= amount`
- Создается транзакция типа `payout` (списание средств)
- Создается запись `Item` (проданный товар)

### 5.3 Возврат средств при проигрыше

**При завершении аукциона:**
- Все оставшиеся активные ставки помечаются как `lost`
- Средства разблокируются: `locked -= amount` (без изменения `total`)
- Создается транзакция типа `bid_refund` (возврат заблокированных средств)

**При отмене аукциона:**
- Все активные ставки помечаются как `refunded`
- Средства разблокируются аналогично проигрышу

### 5.4 Финансовая корректность

Все финансовые операции выполняются в **MongoDB транзакциях** для обеспечения атомарности:
- Блокировка/разблокировка баланса
- Изменение статуса ставки
- Создание транзакций
- Создание записей о товарах

Это гарантирует, что:
- Деньги не теряются
- Деньги не дублируются
- Балансы всегда сходятся
- Невозможны состояния, где ставка выиграла, но деньги не списались

### 5.5 Модель баланса

Баланс пользователя состоит из:
- **total** — общий баланс (в минимальных единицах валюты)
- **locked** — заблокированный баланс (средства в активных ставках)

**Доступный баланс:**
```
available = total - locked
```

**Инварианты:**
- `total >= 0`
- `locked >= 0`
- `locked <= total`

---

## 6. Механизмы против "снайперских" ставок

### 6.1 Автоматическое продление раунда

Если ставка размещена в последние `antiSnipingWindowSec` секунд раунда (по умолчанию 30 секунд), раунд автоматически продлевается на `antiSnipingExtendSec` секунд (по умолчанию 30 секунд).

**Реализация:**
```typescript
const timeLeftMs = auction.roundEndsAt.getTime() - Date.now();
if (timeLeftMs <= config.antiSnipingWindowSec * 1000) {
  auction.roundEndsAt = new Date(
    auction.roundEndsAt.getTime() + config.antiSnipingExtendSec * 1000
  );
}
```

### 6.2 Множественное продление

Механизм может срабатывать многократно:
- Если ставка размещена в последние 30 секунд → раунд продлевается на 30 секунд
- Если в продленное время снова размещена ставка в последние 30 секунд → раунд снова продлевается
- И так далее, пока не пройдет 30 секунд без ставок

Это предотвращает "снайперские" ставки в последнюю секунду, давая другим участникам время на ответ.

### 6.3 Настройка

Параметры настраиваются через переменные окружения:
- `ANTI_SNIPING_WINDOW_SEC` — окно обнаружения (по умолчанию 30)
- `ANTI_SNIPING_EXTEND_SEC` — время продления (по умолчанию 30)

---

## 7. Обработка пограничных случаев

### 7.1 Конкурентные ставки

**Проблема:** Одновременные ставки от разных пользователей могут привести к race conditions.

**Решение:**
- Ставки обрабатываются через очередь **BullMQ** с лимитом 100 операций/секунду
- Каждая ставка обрабатывается в **MongoDB транзакции** для изоляции
- Уникальный индекс: `{ auctionId: 1, userId: 1, status: 1 }` с `partialFilterExpression: { status: "active" }` гарантирует одну активную ставку на пользователя

**Поток обработки:**
1. API получает запрос на ставку
2. Предварительная проверка баланса (без транзакции, для быстрого отказа)
3. Добавление задачи в очередь BullMQ
4. Воркер обрабатывает задачу в MongoDB транзакции
5. Результат транслируется через WebSocket

### 7.2 Одновременное завершение раунда и размещение ставки

**Проблема:** Ставка может быть размещена в момент завершения раунда.

**Решение:**
- Проверка `roundEndsAt` выполняется внутри транзакции
- Если раунд уже завершен, ставка отклоняется с ошибкой "Round has ended"
- Планировщик завершает раунды каждую секунду, но транзакция гарантирует атомарность проверки

### 7.3 Недостаточный баланс

**Проблема:** Баланс может измениться между проверкой и обработкой ставки.

**Решение:**
- Предварительная проверка баланса перед добавлением в очередь (быстрый отказ)
- Финальная проверка баланса внутри транзакции (гарантия корректности)
- Если баланс недостаточен, транзакция откатывается, ставка отклоняется

### 7.4 Отмена аукциона

**Обработка:**
- Все активные ставки помечаются как `refunded`
- Средства разблокируются (возвращаются пользователям)
- Создаются транзакции типа `bid_refund`
- Аукцион помечается как `cancelled`

**Ограничения:**
- Нельзя отменить завершенный или уже отмененный аукцион

### 7.5 Завершение аукциона с неполным количеством товаров

**Сценарий:** `itemsSold < totalItems`, но все раунды пройдены.

**Обработка:**
- Аукцион завершается при `currentRound >= roundsCount`
- Оставшиеся товары не продаются

### 7.6 Завершение аукциона досрочно

**Сценарий:** Все товары проданы до завершения всех раундов (`itemsSold >= totalItems`).

**Обработка:**
- Аукцион завершается досрочно
- Оставшиеся раунды не проводятся
- Все оставшиеся активные ставки помечаются как `lost`, средства возвращаются

### 7.7 Резервная цена не достигнута

**Сценарий:** В раунде нет ставок >= `reservePrice`.

**Обработка:**
- Победителей в раунде нет (или меньше, чем `itemsPerRound`)
- Оставшиеся активные ставки продолжают участие в следующем раунде
- Товары не продаются в этом раунде

---

## 8. Архитектурные решения

### 8.1 Асинхронная обработка ставок

**Почему очереди:**
- Высокая производительность (до 4000+ операций/секунду)
- Защита от перегрузки базы данных
- Возможность масштабирования (несколько воркеров)
- Гарантия обработки (повторные попытки при ошибках)

**Реализация:**
- **BullMQ** для управления очередями
- **Redis** для хранения очередей
- Лимит: 100 операций/секунду на воркер
- Concurrency: 10 одновременных задач на воркер

### 8.2 MongoDB транзакции

**Почему транзакции:**
- Гарантия атомарности финансовых операций
- Изоляция конкурентных запросов
- Консистентность данных

**Использование:**
- Все операции с балансом
- Изменение статуса ставок
- Создание транзакций и записей о товарах

### 8.3 WebSocket для реального времени

**Почему WebSocket:**
- Мгновенные обновления без polling
- Эффективное использование ресурсов
- Поддержка множественных подключений

**События:**
- `bid.updated` — обновление ставки
- `bid.outbid` — вытеснение из топ-списка
- `round.closed` — закрытие раунда
- `auction.started` — запуск аукциона
- `auction.cancelled` — отмена аукциона

### 8.4 Точные расчеты с bigint

**Почему bigint:**
- Криптовалюты имеют высокую точность (до 9 знаков после запятой)
- Избежание ошибок округления с floating point
- Работа с минимальными единицами (nanotons, micro-usdt)

**Реализация:**
- Все суммы хранятся как строки в минимальных единицах
- Конвертация в/из читаемого формата через утилиты `amount.ts`
- Использование `Decimal128` в MongoDB для сортировки

---

## 9. Допущения и ограничения

### 9.1 Допущения

1. **Время сервера** — используется системное время сервера для всех таймеров
2. **Одна валюта на аукцион** — каждый аукцион работает только с одной валютой
3. **Одна активная ставка** — пользователь может иметь только одну активную ставку на аукцион
4. **Только повышение** — ставки можно только увеличивать, нельзя уменьшать
5. **Автоматическое завершение** — раунды завершаются автоматически по таймеру, без ручного вмешательства

### 9.2 Ограничения

1. **Максимальное количество раундов:** 1000
2. **Максимальное количество товаров на раунд:** 1000
3. **Максимальное общее количество товаров:** 10000
4. **Максимальная длительность раунда:** 86400 секунд (24 часа)
5. **Rate limiting:** 100 ставок/секунду на воркер

---

## 10. Тестирование и валидация

### 10.1 Автоматизированное тестирование

Система включает автоматизированные тесты:
- **Anti-Snipe тесты** — проверка продления раундов
- **Нагрузочные тесты** — проверка производительности
- **Стресс-тесты** — проверка стабильности под нагрузкой
- **E2E тесты** — полный цикл аукциона

### 10.2 Финансовая валидация

Все финансовые операции логируются в:
- **Transaction** — история всех транзакций
- **BidHistory** — история изменений ставок
- **EventLog** — события системы

Это позволяет:
- Аудитировать все операции
- Восстанавливать состояние при ошибках
- Отслеживать проблемы

---

## Заключение

Данная спецификация описывает полную механику работы многораундовых аукционов с учетом всех пограничных случаев, механизмов защиты и архитектурных решений. Система спроектирована для обеспечения финансовой корректности, конкурентной безопасности и высокой производительности.
